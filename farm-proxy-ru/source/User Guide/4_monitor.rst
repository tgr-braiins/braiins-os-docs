
.. raw:: html

    <script>
      window.fwSettings={
      'widget_id':77000003511
      };
      !function(){if("function"!=typeof window.FreshworksWidget){var n=function(){n.q.push(arguments)};n.q=[],window.FreshworksWidget=n}}()
    </script>
    <script type='text/javascript' src='https://euc-widget.freshworks.com/widgets/77000003511.js' async defer></script>

##########
Мониторинг
##########

.. contents::
  :local:
  :depth: 2

*************************
Панель управления Графана
*************************

Grafana находится на порту 3000, и к ней можно получить доступ в вашем браузере ``http://<your_host>:3000/``. Grafana работает с очищенными данными из базы данных Prometheus. Есть два типа панелей управления, которые уже подготовлены:

  1. Панели управления Farm Proxy, ориентированные на агрегацию хешрейта и качество сети. Доступны две панели мониторинга:

  Простая панель инструментов под названием «Панель управления клиента», которая является панелью инструментов по умолчанию.

  .. |pic6| image:: ../_static/dashboard.png
      :width: 100%
      :alt: Dashboard

  |pic6|

На информационной панели отображаются следующие показатели и графики:

 * Левая сторона панели инструментов может быть переключена со стандартного хэшрейта на хешрейт devfee.

   * Хешрейт во времени: хешрейты входящего и исходящего потока за последние 5 минут, 1 час и 24 часа,
   * Хешрейт в зависимости от валидности: хешрейты входящего и исходящего потока по принятым или недействительным решениям за последние 3 часа,
   * Временные ряды хешрейта в зависимости от действительности: хешрейты нисходящей и восходящей ветвей, классифицированные по действительности за последние 3 часа.

 * Правая сторона статична.

   * Версия Braiins Farm Proxy,
   * Время запуска Braiins Farm Proxy,
   * Количество нисходящих и восходящих соединений,
   * Соответствующая агрегация,
   * Временные ряды агрегации за последние 3 часа.

Другая панель инструментов называется «Debug Dashboard FP», которая обращает внимание на подробные метрики для целей отладки.

  2. Панели управления Farm Monitor, которые отображают графики и показатели фермы и определенных (отсканированных) майнеров. В настоящее время на этих панелях мониторинга можно отслеживать только майнеры с прошивкой Braiins OS+, но Braiins планирует в ближайшем будущем поддерживать соответствующие модели майнеров, работающих на стандартной прошивке. Подробная информация об этих дашбордах представлена в следующей главе :ref:`Мониторинг Braiins OS+ с помощью Prometheus и Grafana`.

Фермы могут создавать свои собственные информационные панели на основе доступных данных в базе данных Prometheus для удовлетворения своих конкретных потребностей.

.. attention::

    На коротких промежутках времени хэшрейт в нисходящем и восходящем потоках обычно различается. Чем короче таймфрейм, тем выше возможная разница. С одной стороны, сложность в восходящем потоке (сложность, устанавливаемая майнинговым пулом) высока, потому что распространяются только более ценные решения, с другой стороны, сложность в нисходящем потоке низкая, потому что это сложность, устанавливаемая для отдельного майнера. Это означает, что есть много отправлений (с низкой сложностью) в нисходящем направлении и несколько отправлений (с высокой сложностью) в восходящем направлении. Поскольку отправка происходит по пуассоновскому процессу, дисперсия события отправки довольно высока, и на коротком временном интервале не так много отправок, особенно на апстриме. Этот факт приводит к тому, что хешрейт нисходящего и восходящего потоков различается на 5-минутных или даже 1-часовых таймфреймах. С более длинным окном наблюдения хешрейты становятся ближе, и хешрейт за 1 день должен быть почти одинаковым для нисходящего и восходящего потоков.

**********************************************
Расширение существующих информационных панелей
**********************************************

Если ферма уже использует Prometheus и Grafana и хочет обогатить ее метриками и информационными панелями Braiins Farm Proxy, для этого нужно выполнить следующие шаги:

* добавление конфигурации утилизации для Prometheus,

   * farm-proxy: ``http://<farm_proxy>:8080/metrics``,
   * nodeexporter (если запущен): ``http://<farm_proxy>:9100/metrics``,
* импорт дашбордов в Grafana из farm-proxy/monitoring/grafana/provisioning/default_dashboards.

**********
API отчеты
**********

Пользователи Braiins Farm Proxy могут потерять видимость отдельных работников на панели инструментов пула из-за агрегации. Поэтому Braiins Farm Proxy включает в себя API отчеты, которые содержат данные об отдельных воркерах в формате JSON. Набор данных для отчетов состоит из 5-минутных временных интервалов, в которых накапливаются принятые/отклоненные решения, доставленные отдельными майнерами. Количество слотов настраивается, по умолчанию установлено 288, что эквивалентно одному дню. При каждом 5-минутном перевесе самый старый слот закрывается и создается новый. Воркеры, которые не отправились в течение слота, не включаются в результат (и предполагается, что они вообще не доставили решения).

API запрос можно сделать через ``curl localhost:8080/report``. Пример набора данных показан ниже:

.. code-block:: json

      [
        {
          "timestamp": "2022-03-11T18:00:00Z",
          "streams": [
            {
              "name": "v1",
              "direction": "downstream",
              "workers": [
                {
                  "id": "antminer.w1",
                  "shares": {
                    "accepted": 288444,
                    "stale": 0,
                    "invalid": 0
                  },
                  "submits": {
                    "accepted": 7,
                    "stale": 0,
                    "invalid": 0
                  }
                },
                {
                  "id": "antminer.w2",
                  "shares": {
                    "accepted": 0,
                    "stale": 10000,
                    "invalid": 0
                  },
                  "submits": {
                    "accepted": 0,
                    "stale": 2,
                    "invalid": 0
                  },
                }
              ]
            },
            {
              "name": "SP-EU-G1",
              "direction": "upstream",
              "workers": [
                {
                  "id": "btcpmxyz.goal_1",
                  "shares": {
                    "accepted": 288444,
                    "rejected": 0
                  },
                  "submits": {
                    "accepted": 3,
                    "rejected": 0
                  },
                }
              ]
            }
          ]
        },
        {
          "timestamp": "2022-03-11T18:05:00Z",
          "streams": [
            {
              "name": "v1",
              "direction": "downstream",
              "workers": [
                {
                  "id": "antminer.w1",
                  "shares": {
                    "accepted": 300200,
                    "stale": 0,
                    "invalid": 0
                  },
                  "submits": {
                    "accepted": 2,
                    "stale": 0,
                    "invalid": 0
                  }
                }
              ]
            },
            {
              "name": "SP-EU-G1",
              "direction": "upstream",
              "workers": [
                {
                  "id": "btcpmxyz.goal_1",
                  "shares": {
                    "accepted": 300200,
                    "rejected": 0
                  },
                  "submits": {
                    "accepted": 2,
                    "rejected": 0
                  },
                }
              ]
            }
          ]
        }
      ]

****
Логи
****

Braiins Farm Proxy сохраняет свои логи в контейнере Docker. Docker настроен на хранение не более 5 ГБ логов. Производится ротация и сжатие логов. Количество файлов лога установлено равным 50, и логика заключается в том, что самый старый файл удаляется и создается новый. Максимальный размер 1 файла — 100 МБ. Вот несколько полезных команд для исследования логов (подробнее см. ``docker logs --help``):

 * все доступные логи: ``docker logs farm-proxy``
 * последних 200 логов: ``docker logs farm-proxy –-tail 200``
 * логи за последних 20 минут: ``docker logs farm-proxy --since "20m"``
 * логи с указаного времени: ``docker logs farm-proxy --since "2022-03-30T05:20:00"``
 * логи во временном интервале: ``docker logs farm-proxy --since "2022-03-30T05:20:00" --until "2022-03-30T05:21:36"``

Логи сохраняются в */var/lib/docker/containers/<container_id>/<container_id>-json.log*.
