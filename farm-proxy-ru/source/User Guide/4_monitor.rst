
.. raw:: html

    <script>
      window.fwSettings={
      'widget_id':77000003511
      };
      !function(){if("function"!=typeof window.FreshworksWidget){var n=function(){n.q.push(arguments)};n.q=[],window.FreshworksWidget=n}}()
    </script>
    <script type='text/javascript' src='https://euc-widget.freshworks.com/widgets/77000003511.js' async defer></script>

##########
Мониторинг
##########

.. contents::
  :local:
  :depth: 2

*************************
Панель управления Графана
*************************

Grafana находится на порту 3000, и к ней можно получить доступ в вашем браузере ``http://<your_host>:3000/``. Grafana работает с очищенными данными из базы данных Prometheus. Простая панель под названием «Панель клиента» уже готова.

  .. |pic6| image:: ../_static/dashboard.png
      :width: 100%
      :alt: Dashboard

  |pic6|

На информационных панелях отображаются следующие показатели и графики:

 * Левая сторона панели инструментов может быть переключена со стандартного хэшрейта на хешрейт devfee.

   * Хешрейт во времени: хешрейты входящего и исходящего потока за последние 5 минут, 1 час и 24 часа,
   * Хешрейт в зависимости от валидности: хешрейты входящего и исходящего потока по принятым или недействительным решениям за последние 3 часа,
   * Временные ряды хешрейта в зависимости от действительности: хешрейты нисходящей и восходящей ветвей, классифицированные по действительности за последние 3 часа.

 * Правая сторона статична.

   * Версия Braiins Farm Proxy,
   * Время запуска Braiins Farm Proxy,
   * Количество нисходящих и восходящих соединений,
   * Соответствующая агрегация,
   * Временные ряды агрегации за последние 3 часа.

Grafana также содержит вторую панель мониторинга по умолчанию под названием Debug Dashboard FP, которая уделяет внимание подробным метрикам для целей отладки.

Фермы могут создавать свои собственные информационные панели на основе доступных данных в базе данных Prometheus для удовлетворения своих конкретных потребностей.

**********************************************
Расширение существующих информационных панелей
**********************************************

Если ферма уже использует Prometheus и Grafana и хочет обогатить ее метриками и информационными панелями Braiins Farm Proxy, для этого нужно выполнить следующие шаги:

* добавление конфигурации утилизации для Prometheus,

   * farm-proxy: ``http://<farm_proxy>:8080/metrics``,
   * nodeexporter (если запущен): ``http://<farm_proxy>:9100/metrics``,
* импорт дашбордов в Grafana из farm-proxy/monitoring/grafana/dashboards.

**********
API отчеты
**********

Пользователи Braiins Farm Proxy могут потерять видимость отдельных работников на панели инструментов пула из-за агрегации. Поэтому Braiins Farm Proxy включает в себя API отчеты, которые содержат данные об отдельных воркерах в формате JSON. Набор данных для отчетов состоит из 5-минутных временных интервалов, в которых накапливаются принятые/отклоненные решения, доставленные отдельными майнерами. Количество слотов настраивается, по умолчанию установлено 288, что эквивалентно одному дню. При каждом 5-минутном перевесе самый старый слот закрывается и создается новый. Воркеры, которые не отправились в течение слота, не включаются в результат (и предполагается, что они вообще не доставили решения).

API запрос можно сделать через ``curl localhost:8080/report``. Пример набора данных показан ниже:

.. code-block:: json

      [
        {
          "timestamp": "2022-03-11T18:00:00Z",
          "streams": [
            {
              "name": "v1",
              "direction": "downstream",
              "workers": [
                {
                  "id": "antminer.w1",
                  "shares": {
                    "accepted": 288444,
                    "stale": 0,
                    "invalid": 0
                  },
                  "submits": {
                    "accepted": 7,
                    "stale": 0,
                    "invalid": 0
                  }
                },
                {
                  "id": "antminer.w2",
                  "shares": {
                    "accepted": 0,
                    "stale": 10000,
                    "invalid": 0
                  },
                  "submits": {
                    "accepted": 0,
                    "stale": 2,
                    "invalid": 0
                  },
                }
              ]
            },
            {
              "name": "SP-EU-G1",
              "direction": "upstream",
              "workers": [
                {
                  "id": "btcpmxyz.goal_1",
                  "shares": {
                    "accepted": 288444,
                    "rejected": 0
                  },
                  "submits": {
                    "accepted": 3,
                    "rejected": 0
                  },
                }
              ]
            }
          ]
        },
        {
          "timestamp": "2022-03-11T18:05:00Z",
          "streams": [
            {
              "name": "v1",
              "direction": "downstream",
              "workers": [
                {
                  "id": "antminer.w1",
                  "shares": {
                    "accepted": 300200,
                    "stale": 0,
                    "invalid": 0
                  },
                  "submits": {
                    "accepted": 2,
                    "stale": 0,
                    "invalid": 0
                  }
                }
              ]
            },
            {
              "name": "SP-EU-G1",
              "direction": "upstream",
              "workers": [
                {
                  "id": "btcpmxyz.goal_1",
                  "shares": {
                    "accepted": 300200,
                    "rejected": 0
                  },
                  "submits": {
                    "accepted": 2,
                    "rejected": 0
                  },
                }
              ]
            }
          ]
        }
      ]

****
Логи
****

Braiins Farm Proxy сохраняет свои логи в контейнере Docker. Docker настроен на хранение не более 5 ГБ логов. Производится ротация и сжатие логов. Количество файлов лога установлено равным 50, и логика заключается в том, что самый старый файл удаляется и создается новый. Максимальный размер 1 файла — 100 МБ. Вот несколько полезных команд для исследования логов (подробнее см. ``docker logs --help``):

 * все доступные логи: ``docker logs farm-proxy``
 * последних 200 логов: ``docker logs farm-proxy –-tail 200``
 * логи за последних 20 минут: ``docker logs farm-proxy --since "20m"``
 * логи с указаного времени: ``docker logs farm-proxy --since "2022-03-30T05:20:00"``
 * логи во временном интервале: ``docker logs farm-proxy --since "2022-03-30T05:20:00" --until 2022-03-30T05:21:36"``

Логи сохраняются в */var/lib/docker/containers/<container_id>/<container_id>-json.log*.
